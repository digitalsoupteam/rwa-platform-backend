worker_processes auto;
pid /var/run/nginx.pid;

# Load OpenTelemetry and VTS modules
load_module modules/ngx_otel_module.so;
load_module modules/ngx_http_vhost_traffic_status_module.so;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # OpenTelemetry configuration
    otel_exporter {
        endpoint alloy:4319;
        interval 5s;
        batch_size 512;
        batch_count 4;
    }
    
    otel_service_name "nginx-gateway";
    otel_resource_attr "service.version" "1.29.0";
    otel_resource_attr "deployment.environment" "production";
    otel_resource_attr "service.namespace" "rwa-platform";
    
    # VTS module configuration
    vhost_traffic_status_zone;
    
    keepalive_timeout 65;
    keepalive_requests 100;
    client_header_timeout 60s;
    client_body_timeout 60s;
    send_timeout 60s;

    upstream gateway_backend {
        server gateway:3000;
        keepalive 32; 
    }

    server {
        listen 443 ssl;
        server_name _;

        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        location /gateway/graphql/stream {
            proxy_pass http://gateway_backend/graphql/stream;
            proxy_http_version 1.1;
            
            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Accept, X-HTTP2-Support' always;
            
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Content-Type, Accept, X-HTTP2-Support';
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                add_header 'Content-Length' 0;
                return 204;
            }
            
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;

            
            proxy_set_header Connection '';
            proxy_buffering off;
            proxy_cache off;

            
            proxy_read_timeout 24h;
            proxy_send_timeout 24h;
            
            
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            
            proxy_ignore_client_abort off;
            proxy_connect_timeout 60s;
        }

        # Static files from files service
        location /files/ {
            alias /app/storage/;
            
            # Security headers
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
            add_header X-XSS-Protection "1; mode=block";
            
            # CORS headers for file access
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Accept' always;
            
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Content-Type, Accept';
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                add_header 'Content-Length' 0;
                return 204;
            }
            
            # Cache settings for static files
            expires 1y;
            add_header Cache-Control "public, immutable";
            
            # Try to serve file directly, return 404 if not found
            try_files $uri =404;
        }

        location /gateway/graphql {
            # Enable OpenTelemetry tracing for this location
            otel_trace on;
            otel_trace_context propagate;
            otel_span_name "nginx_graphql_proxy";
            otel_span_attr "http.route" "/gateway/graphql";
            
            proxy_pass http://gateway_backend/graphql;
            proxy_http_version 1.1;
            
            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Accept, X-HTTP2-Support, Authorization, traceparent, tracestate' always;
            
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Content-Type, Accept, X-HTTP2-Support, Authorization, traceparent, tracestate';
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                add_header 'Content-Length' 0;
                return 204;
            }
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # OpenTelemetry trace context headers are automatically propagated by otel_trace_context propagate
            # No need to manually set headers - they are handled by the OpenTelemetry module
        }

        # Administration services with Basic Authentication
        location /administration/grafana/ {
             # Basic Authentication
            auth_basic "Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

            rewrite  ^/grafana/(.*)  /$1 break;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_pass http://grafana:3000;
        }

        location /administration/prometheus/ {
            # Basic Authentication
            auth_basic "Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

            proxy_pass http://prometheus:9090/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Fix for static resources
            sub_filter_types *;
            sub_filter_once off;
            sub_filter 'href="/' 'href="/administration/prometheus/';
            sub_filter 'src="/' 'src="/administration/prometheus/';
            sub_filter 'action="/' 'action="/administration/prometheus/';
        }

        location /administration/loki/ {
            # Basic Authentication
            auth_basic "Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

            proxy_pass http://loki:3100/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Fix for static resources
            sub_filter_types *;
            sub_filter_once off;
            sub_filter 'href="/' 'href="/administration/loki/';
            sub_filter 'src="/' 'src="/administration/loki/';
            sub_filter 'action="/' 'action="/administration/loki/';
        }

        location /administration/tempo/ {
            # Basic Authentication
            auth_basic "Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

            proxy_pass http://tempo:3200/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /administration/alloy/ {
            # Basic Authentication
            auth_basic "Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

            proxy_pass http://alloy:12345/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Fix for static resources
            sub_filter_types *;
            sub_filter_once off;
            sub_filter 'href="/' 'href="/administration/alloy/';
            sub_filter 'src="/' 'src="/administration/alloy/';
            sub_filter 'action="/' 'action="/administration/alloy/';
        }

        location /administration/rabbitmq/ {
            # Basic Authentication
            auth_basic "Restricted Access";
            auth_basic_user_file /etc/nginx/conf.d/.htpasswd;

            proxy_pass http://rabbitmq:15672/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTP server for metrics (Prometheus access)
    server {
        listen 80;
        server_name _;
        
        # VTS status endpoint for Prometheus metrics
        location /status {
            vhost_traffic_status_display;
            vhost_traffic_status_display_format prometheus;
            access_log off;
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            allow 172.16.0.0/12;
            allow 192.168.0.0/16;
            deny all;
        }
        
        # Redirect all other requests to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
}